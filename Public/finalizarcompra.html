<script>
  const deliveryButtons = document.querySelectorAll('.delivery-btn');
  const pickupForm = document.getElementById('pickup-form');
  const shippingForm = document.getElementById('shipping-form');

  deliveryButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      deliveryButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (btn.dataset.type === 'pickup') {
        pickupForm.classList.remove('hidden');
        shippingForm.classList.add('hidden');
      } else {
        shippingForm.classList.remove('hidden');
        pickupForm.classList.add('hidden');
      }
    });
  });

  function closePopup() {
    document.getElementById("success-popup").style.display = "none";
    window.location.href = "index.html";
  }

  function getCart() {
    const directBuy = JSON.parse(localStorage.getItem("directBuy"));
    if (directBuy) return directBuy;
    return JSON.parse(localStorage.getItem("cart")) || [];
  }

  function renderOrderSummary() {
    const cart = getCart();
    const container = document.getElementById("order-summary");
    container.innerHTML = "";
    if (cart.length === 0) {
      container.innerHTML = "<p>Tu carrito est√° vac√≠o.</p>";
      document.getElementById("final-total").textContent = "‚Ç°0";
      return;
    }
    let total = 0;
    cart.forEach(item => {
      const subtotal = Number(item.price) * item.cantidad;
      total += subtotal;
      const div = document.createElement("div");
      div.classList.add("product");
      div.innerHTML = `
        <img src="${item.img}" alt="${item.name}">
        <div class="product-info">
          <h4>${item.name}</h4>
          <p>Talla: ${item.talla}</p>
          <p>Cantidad: ${item.cantidad}</p>
          <p>Subtotal: ‚Ç°${subtotal.toLocaleString()}</p>
        </div>
      `;
      container.appendChild(div);
    });
    document.getElementById("final-total").textContent = "‚Ç°" + total.toLocaleString();
  }

  document.addEventListener("DOMContentLoaded", renderOrderSummary);

  document.getElementById("finalizar-pedido").addEventListener("click", async () => {
    const cart = getCart();
    if (cart.length === 0) {
      alert("Tu carrito est√° vac√≠o.");
      return;
    }

    const deliveryType = document.querySelector('.delivery-btn.active').dataset.type;

    const cliente = deliveryType === "pickup" ? {
      nombre: document.getElementById("nombre").value.trim(),
      apellidos: document.getElementById("apellidos").value.trim(),
      telefono: document.getElementById("telefono").value.trim(),
      email: document.getElementById("email").value.trim()
    } : {
      nombre: document.getElementById("nombre-envio").value.trim(),
      apellidos: document.getElementById("apellidos-envio").value.trim(),
      telefono: document.getElementById("telefono-envio").value.trim(),
      email: document.getElementById("email-envio").value.trim(),
      direccion: document.getElementById("direccion").value.trim(),
      provincia: document.getElementById("provincia").value.trim(),
      ciudad: document.getElementById("ciudad").value.trim(),
      codigoPostal: document.getElementById("codigo-postal").value.trim()
    };

    if (!cliente.nombre || !cliente.apellidos || !cliente.telefono || !cliente.email) {
      alert("Por favor completa todos los campos obligatorios.");
      return;
    }

    const total = cart.reduce((sum, p) => sum + (Number(p.price) * p.cantidad), 0);
    const productosTexto = cart.map(p => `${p.name} (${p.cantidad})`).join(", ");

    console.log("üì¶ Enviando pedido:", cliente, productosTexto, total);

    const templateParams = {
      nombre: cliente.nombre,
      apellidos: cliente.apellidos,
      telefono: cliente.telefono,
      email: cliente.email,
      productos: productosTexto,
      total: total.toLocaleString(),
      deliveryType: deliveryType === "pickup" ? "Recolectar" : "Env√≠o a domicilio"
    };

    // --- Correo al cliente ---
    emailjs.send("service_olesnyd", "template_wz6kcm9", templateParams)
      .then(res => console.log("‚úÖ Correo cliente enviado:", res))
      .catch(err => console.error("‚ùå Error correo cliente:", err));

    // --- Correo a tu novia ---
    emailjs.send("service_olesnyd", "template_ycupd5q", templateParams)
      .then(res => console.log("‚úÖ Correo novia enviado:", res))
      .catch(err => console.error("‚ùå Error correo novia:", err));

    // üî• MARCAR PRODUCTOS COMO VENDIDOS
    for (const item of cart) {
      if (item.id) {
        try {
          await fetch(`http://localhost:3000/api/productos/${item.id}/vender`, {
            method: "PUT"
          });
        } catch (error) {
          console.error("‚ùå Error marcando producto como vendido:", error);
        }
      }
    }

    localStorage.removeItem("cart");
    localStorage.removeItem("directBuy");
    document.getElementById("success-popup").style.display = "flex";
  });
</script>
