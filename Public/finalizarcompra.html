<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Finalizar Compra - AVS</title>
  <link rel="stylesheet" href="css/finalizarcompra.css">
</head>
<body>
  <header class="main-header">
    <a href="index.html" class="logo">AVS</a>
  </header>

  <main class="checkout-container">
    <section class="form-section">
      <h2>Entrega</h2>

      <div class="delivery-buttons">
        <button type="button" class="delivery-btn active" data-type="pickup">Recolectar</button>
        <button type="button" class="delivery-btn" data-type="shipping">Envío a domicilio</button>
      </div>

      <div id="pickup-form" class="delivery-form">
        <h3>Datos para recoger</h3>
        <div class="form-row">
          <input id="nombre" type="text" placeholder="Nombre" required>
          <input id="apellidos" type="text" placeholder="Apellidos" required>
        </div>
        <input id="telefono" type="text" placeholder="Teléfono" required>
        <input id="email" type="email" placeholder="Correo electrónico" required>
      </div>

      <div id="shipping-form" class="delivery-form hidden">
        <h3>Datos de envío</h3>
        <select>
          <option value="CR">Costa Rica</option>
        </select>
        <div class="form-row">
          <input id="nombre-envio" type="text" placeholder="Nombre" required>
          <input id="apellidos-envio" type="text" placeholder="Apellidos" required>
        </div>
        <input id="direccion" type="text" placeholder="Dirección" required>
        <input id="detalle" type="text" placeholder="Casa, apartamento, etc. (opcional)">
        <div class="form-row">
          <input id="provincia" type="text" placeholder="Provincia / Estado">
          <input id="ciudad" type="text" placeholder="Ciudad">
          <input id="codigo-postal" type="text" placeholder="Código Postal">
        </div>
        <input id="telefono-envio" type="text" placeholder="Teléfono" required>
        <input id="email-envio" type="email" placeholder="Correo electrónico" required>
      </div>

      <section class="payment-section">
        <h2>Pago</h2>
        <p>Sinpe Móvil o Transferencia</p>
        <p class="payment-info">
          El pago se realiza por medio del Sinpe Móvil: Acuña Chavarría 86072876
        </p>
      </section>

      <div class="btn-wrapper">
        <button id="finalizar-pedido">Finalizar Pedido</button>
      </div>
    </section>

    <aside class="summary-section">
      <h2>Resumen del pedido</h2>
      <div id="order-summary"></div>
      <p class="total">Total: <span id="final-total">₡0</span></p>
    </aside>
  </main>

  <div id="success-popup" class="popup">
    <div class="popup-content">
      <span class="close" onclick="closePopup()">&times;</span>
      <h2>Pedido realizado exitosamente</h2>
      <p>Gracias por tu compra. Te enviamos la factura por correo.</p>
    </div>
  </div>

  <script>
    const deliveryButtons = document.querySelectorAll('.delivery-btn');
    const pickupForm = document.getElementById('pickup-form');
    const shippingForm = document.getElementById('shipping-form');

    deliveryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        deliveryButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(btn.dataset.type === 'pickup') {
          pickupForm.classList.remove('hidden');
          shippingForm.classList.add('hidden');
        } else {
          shippingForm.classList.remove('hidden');
          pickupForm.classList.add('hidden');
        }
      });
    });

    function closePopup() {
      document.getElementById("success-popup").style.display = "none";
      window.location.href = "index.html";
    }

    function getCart() {
      const directBuy = JSON.parse(localStorage.getItem("directBuy"));
      if (directBuy) return directBuy;
      return JSON.parse(localStorage.getItem("cart")) || [];
    }

    function renderOrderSummary() {
      const cart = getCart();
      const container = document.getElementById("order-summary");
      container.innerHTML = "";
      if (cart.length === 0) {
        container.innerHTML = "<p>Tu carrito está vacío.</p>";
        document.getElementById("final-total").textContent = "₡0";
        return;
      }
      let total = 0;
      cart.forEach(item => {
        const subtotal = Number(item.price) * item.cantidad;
        total += subtotal;
        const div = document.createElement("div");
        div.classList.add("product");
        div.innerHTML = `
          <img src="${item.img}" alt="${item.name}">
          <div class="product-info">
            <h4>${item.name}</h4>
            <p>Talla: ${item.talla}</p>
            <p>Cantidad: ${item.cantidad}</p>
            <p>Subtotal: ₡${subtotal.toLocaleString()}</p>
          </div>
        `;
        container.appendChild(div);
      });
      document.getElementById("final-total").textContent = "₡" + total.toLocaleString();
    }

    document.addEventListener("DOMContentLoaded", renderOrderSummary);

    document.getElementById("finalizar-pedido").addEventListener("click", async () => {
      const cart = getCart();
      if (cart.length === 0) return;

      const deliveryType = document.querySelector('.delivery-btn.active').dataset.type;

      const cliente = deliveryType === "pickup" ? {
        nombre: document.getElementById("nombre").value,
        apellidos: document.getElementById("apellidos").value,
        telefono: document.getElementById("telefono").value,
        email: document.getElementById("email").value
      } : {
        nombre: document.getElementById("nombre-envio").value,
        apellidos: document.getElementById("apellidos-envio").value,
        telefono: document.getElementById("telefono-envio").value,
        email: document.getElementById("email-envio").value,
        direccion: document.getElementById("direccion").value,
        provincia: document.getElementById("provincia").value,
        ciudad: document.getElementById("ciudad").value,
        codigoPostal: document.getElementById("codigo-postal").value
      };

      const total = cart.reduce((sum, p) => sum + (Number(p.price) * p.cantidad), 0);

      try {
        const response = await fetch('/api/pedidos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cliente, deliveryType, productos: cart, total })
        });

        if (!response.ok) throw new Error("Error al guardar el pedido");

        localStorage.removeItem("cart");
        localStorage.removeItem("directBuy");
        document.getElementById("success-popup").style.display = "flex";

      } catch (err) {
        console.error(err);
        alert("Ocurrió un error al finalizar el pedido. Intenta de nuevo.");
      }
    });
  </script>
</body>
</html>
