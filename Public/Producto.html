<script>
async function cargarProducto() {
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');

  if (!id) return;

  try {
    const res = await fetch(`https://avs-app.onrender.com/api/productos/${id}`);
    const producto = await res.json();

    if (!producto || !producto.imagenes) throw new Error('Producto no encontrado');

    const slider = document.getElementById('slider');
    slider.innerHTML = "";

    producto.imagenes.forEach(src => {
      const img = document.createElement("img");
      img.src = src.startsWith("/") ? src.slice(1) : src;
      img.alt = producto.nombre;
      slider.appendChild(img);
    });

    document.getElementById('prod-name').textContent = producto.nombre;
    document.getElementById('prod-price').textContent = `â‚¡${Number(producto.precio).toLocaleString()}`;
    document.getElementById('prod-talla').textContent = `Talla: ${producto.talla || 'Ãšnica'}`;

    const addCartBtn = document.getElementById('add-cart');
    const buyBtn = document.querySelector('.btn-buy');
    const banner = document.getElementById('banner-vendido');

    // ðŸ”’ VALIDACIÃ“N CLAVE (con "F")
    if (producto.estado === "F") {
      banner.style.display = 'block';
      addCartBtn.disabled = true;
      buyBtn.disabled = true;
      addCartBtn.textContent = "Vendido";
      buyBtn.textContent = "Vendido";
      addCartBtn.style.opacity = '0.5';
      buyBtn.style.opacity = '0.5';
      addCartBtn.style.cursor = 'not-allowed';
      buyBtn.style.cursor = 'not-allowed';
    } else {
      banner.style.display = 'none';
      addCartBtn.disabled = false;
      buyBtn.disabled = false;
      addCartBtn.textContent = "Agregar al carrito";
      buyBtn.textContent = "Comprar ahora";
      addCartBtn.style.opacity = '1';
      buyBtn.style.opacity = '1';
      addCartBtn.style.cursor = 'pointer';
      buyBtn.style.cursor = 'pointer';
    }

    window.productoActual = producto;

  } catch(err){
    console.error(err);
  }
}

cargarProducto();

function getCart() {
  return JSON.parse(localStorage.getItem("cart")) || [];
}

function saveCart(cart) {
  localStorage.setItem("cart", JSON.stringify(cart));
}

function updateCartCount() {
  const cart = getCart();
  const totalItems = cart.reduce((sum, p) => sum + p.cantidad, 0);
  localStorage.setItem("cartCount", totalItems);
}

// ðŸ›’ Agregar al carrito
document.getElementById("add-cart").addEventListener("click", () => {
  if (!window.productoActual) return;

  // ðŸš« Bloqueo extra por seguridad
  if (window.productoActual.estado === "F") {
    alert("Este producto ya fue vendido.");
    return;
  }

  const producto = window.productoActual;
  const name = producto.nombre;
  const price = Number(producto.precio); 
  const talla = producto.talla || 'Ãšnica';
  const img = producto.imagenes[0].startsWith("/") ? producto.imagenes[0].slice(1) : producto.imagenes[0];

  let cart = getCart();
  const index = cart.findIndex(p => p.id === producto.id);

  if (index >= 0) {
    cart[index].cantidad++;
  } else {
    cart.push({ 
      id: producto.id,
      name, 
      price, 
      img, 
      talla, 
      cantidad: 1 
    });
  }

  saveCart(cart);
  updateCartCount();

  window.location.href = "NuevoDrop.html";
});

// âš¡ Comprar ahora directo
document.querySelector(".btn-buy").addEventListener("click", () => {
  if (!window.productoActual) return;

  // ðŸš« Bloqueo extra por seguridad
  if (window.productoActual.estado === "F") {
    alert("Este producto ya fue vendido.");
    return;
  }

  const producto = {
    id: window.productoActual.id,
    name: window.productoActual.nombre,
    price: Number(window.productoActual.precio),
    talla: window.productoActual.talla || "Ãšnica",
    img: window.productoActual.imagenes[0].startsWith("/") 
          ? window.productoActual.imagenes[0].slice(1) 
          : window.productoActual.imagenes[0],
    cantidad: 1
  };

  localStorage.setItem("directBuy", JSON.stringify([producto]));
  window.location.href = "finalizarcompra.html";
});
</script>
